# OPAL Test Pipeline Configuration
# Processes a small subset of OPAL data for testing

# Defining data folder structure
folder_structure:
  data_root_folder: &BASE /media/sz/Data/Connected_Lecturers/Opal_test
  raw_data_folder: &RAW !join [*BASE, /raw]
  file_folder: &FILE_FOLDER !join [*RAW, /files]
  content_folder: &CONTENT_FOLDER !join [*RAW, /content]
  processed_data_folder: &PREPROCESSED !join [*BASE, /processed]

# Global LLM Configuration (can be overridden in individual stages)
global_llm_config: &LLM_CONFIG
  base_url: "http://localhost:11434"
  embedding_model: "jina/jina-embeddings-v2-base-de"
  collection_name: "oer_connected_lecturer_test"
  timeout_seconds: 240
  chroma_db_folder: "chroma_db_test"  # ChromaDB database folder for test

# Global Logging Configuration
logging:
  configure_root_logger: false  # Whether to configure the root logger
  root_level: "ERROR"          # Level for root logger (if enabled)
  pipeline_level: "INFO"       # Level for pipeline-specific loggers

  # External logger configuration (overrides default values)
  external_loggers:
    # HTTP and network - set to CRITICAL for less noise
    httpcore: "CRITICAL"
    "httpcore.http11": "CRITICAL"
    httpx: "CRITICAL"
    urllib3: "CRITICAL"
    "urllib3.connectionpool": "CRITICAL"
    requests: "CRITICAL"

    # LangChain and AI - set to WARNING for important messages
    langchain: "WARNING"
    langchain_ollama: "WARNING"
    "langchain_text_splitters.base": "ERROR"
    ollama: "WARNING"

    # Image processing - set to WARNING
    PIL: "WARNING"
    "PIL.PngImagePlugin": "WARNING"

    # Unstructured - set to CRITICAL for less noise
    "unstructured.trace": "CRITICAL"

# Referencing the modules containing classes
stages_module_path:
    - ../stages/general/
    - ../stages/opal/

# Defining stages and parameters
stages:
  - name: Generate data folder structure
    class: ProvideDataFolders

  - name: Collect raw data from OPAL
    class: CollectOPALOERdocuments
    parameters:
      repo_file_name: OPAL_repos_test.p
      file_name: &OPALSINGLEFILES OPAL_files_test.p
      json_file_name: OPAL_raw_data_test.json
      json_url: https://bildungsportal.sachsen.de/opal/oer/content.json
      force_run: False

  - name: Aggregate basic features from OPAL
    class: Preprocessing
    parameters:
      file_name_input: *OPALSINGLEFILES
      file_name_output: &OPALSINGLEFILESATTRIB OPAL_files_attrib_test.p
      force_run: False

  - name: Download files
    class: DownloadOERFromOPAL
    parameters:
      file_name_input: *OPALSINGLEFILESATTRIB
      file_name_output: &OPALSINGLEFILESDOWNLOADS OPAL_files_downloads_test.p
      file_types: ['pdf', 'pptx', 'docx', 'xlsx', 'md']  # Mix of file types for testing
      force_run: True
      max_downloads_per_type: 5  # Download 5 files of each type (balanced mix)
      max_total_downloads: 20    # Maximum 20 total downloads

  - name: Extract meta data from OPAL files
    class: MetaDataExtraction
    parameters:
      file_name_input: *OPALSINGLEFILESDOWNLOADS
      file_name_output: &OPALSINGLEFILESMETA OPAL_files_meta_test.p
      file_types: ['pdf', 'pptx', 'docx', 'xlsx', 'md']
      force_run: True

  - name: Extract content
    class: ExtractFileContent
    parameters:
      file_name_input: *OPALSINGLEFILESDOWNLOADS
      file_name_output: &OPALSINGLEAICONTENT OPAL_content_test.p
      force_run: True
      file_types: ['pdf', 'pptx', 'docx', 'xlsx', 'md']

  - name: Filter file list by content data
    class: FilterFilesByContent
    parameters:
      file_name_input: *OPALSINGLEFILESDOWNLOADS
      file_content: *OPALSINGLEAICONTENT
      file_name_output: &OPALSINGLEFILESFILTERED OPAL_files_filtered_test.p
      force_run: True

  - name: Provide embeddings
    class: AIEmbeddingsGeneration
    parameters:
      file_name_input: *OPALSINGLEFILESFILTERED
      file_name_output: &OPALCHROMAFILES OPAL_embeddings_files_test.p
      force_run: True
      file_types: ['pdf', 'pptx', 'docx', 'xlsx', 'md']

      # LLM and Vector Store Configuration
      llm_config:
        base_url: "http://localhost:11434"
        embedding_model: "jina/jina-embeddings-v2-base-de"
        collection_name: "oer_connected_lecturer_test"
        timeout_seconds: 240
        chroma_db_folder: "chroma_db_test"

  - name: Extract meta data from content
    class: AIMetaDataExtraction
    parameters:
      file_name_input: *OPALSINGLEFILESFILTERED
      file_name_output: &OPALSINGLEAIMETA OPAL_ai_meta_test.p
      prompts_file_name: pipelines/opal/prompts/prompts.yaml
      dewey_classification_file: pipelines/shared/dewey_classification.txt
      model_name: llama3:70b
      force_run: True
      file_types: ['pdf', 'pptx', 'docx', 'xlsx', 'md']

      # LLM and Vector Store Configuration
      llm_config:
        base_url: "http://localhost:11434"
        embedding_model: "jina/jina-embeddings-v2-base-de"
        collection_name: "oer_connected_lecturer_test"
        timeout_seconds: 240
        chroma_db_folder: "chroma_db_test"

      # Retrieval configuration
      max_retrieval_chunks: 10
      retrieval_strategy: "all"

      # Processing mode configuration
      processing_mode:
        # Force processing: These fields are ALWAYS processed (overwrite existing data)
        force_processing:    # [] Empty list = no force processing
          - ai:affiliation
          - ai:dewey
          - ai:author

        # Conditional processing: These fields are only processed if empty/missing
        conditional_processing:
          - ai:author
          - ai:keywords_gen
          - ai:title
          - ai:type
          - ai:keywords_ext
          - ai:keywords_dnb
          - ai:summary

        # Skip configuration: Skip file if NO conditional fields need processing
        allow_skip_when_all_conditional_filled: false

  - name: Check Keywords
    class: GNDKeywordCheck
    parameters:
      file_name_input: *OPALSINGLEAIMETA
      file_name_output: &OPALKEYWORDS OPAL_checked_keywords_test.p
      force_run: True
      use_llm: true         # KI-basierte Schlagwortauswahl aktivieren
      llm_model: "gemma3:27b"  # Ollama-Modell für Schlagwortauswahl
      use_full_keyword_context: true  # Alle Keywords eines Dokuments als Kontext verwenden
      use_document_metadata: true     # Zusätzliche Dokumentmetadaten als Kontext einbeziehen

  - name: Determine similarity between files
    class: DocumentSimilarity
    parameters:
      file_name_input: *OPALSINGLEFILESFILTERED
      file_name_output: &OPALAISIMILARITY OPAL_ai_similaritiy_test.p
      force_run: True

      # Vector Store Configuration
      llm_config:
        collection_name: "oer_connected_lecturer_test"
        chroma_db_folder: "chroma_db_test"
