# Defining data folder structure
folder_structure:
  #data_root_folder: &BASE ./data
  data_root_folder: &BASE /media/sz/Data/Connected_Lecturers/LiaScript
  raw_data_folder: &RAW !join [*BASE, /raw]
  file_folder: &FILE_FOLDER !join [*RAW, /files]
  content_folder: &CONTENT_FOLDER !join [*RAW, /content]
  processed_data_folder: &PREPROCESSED !join [*BASE, /processed]

# Global LLM Configuration (can be overridden in individual stages)
global_llm_config: &LLM_CONFIG
  base_url: "http://localhost:11434"
  embedding_model: "jina/jina-embeddings-v2-base-de"
  collection_name: "liascript_courses"
  timeout_seconds: 240
  chroma_db_folder: "chroma_db"  # ChromaDB database folder

# Global Logging Configuration
logging:
  configure_root_logger: false  # Whether to configure the root logger
  root_level: "ERROR"          # Level for root logger (if enabled)
  pipeline_level: "INFO"       # Level for pipeline-specific loggers

  # External logger configuration (overrides default values)
  external_loggers:
    # HTTP and network - set to CRITICAL for less noise
    httpcore: "CRITICAL"
    "httpcore.http11": "CRITICAL"
    httpx: "CRITICAL"
    urllib3: "CRITICAL"
    "urllib3.connectionpool": "CRITICAL"
    requests: "CRITICAL"

    # LangChain and AI - set to WARNING for important messages
    langchain: "WARNING"
    langchain_ollama: "WARNING"
    "langchain_text_splitters.base": "ERROR"
    ollama: "WARNING"

    # Image processing - set to WARNING
    PIL: "WARNING"
    "PIL.PngImagePlugin": "WARNING"

    # Unstructured - set to CRITICAL for less noise
    "unstructured.trace": "CRITICAL"

# Referencing the modules containing classes
stages_module_path:
    - ../stages/general/
    - ../stages/liascript/
    - ../stages/opal/

# Defining stages and parameters
stages:
  - name: Generate data folder structure
    class: ProvideDataFolders

  - name: Identify LiaScript repositories
    class: CrawlGithubForLiaScript
    parameters:
      repo_data_file_name: &REPOSITORIES_DF LiaScript_repositories.p
      force_run: False
      #internal: ['LiaScript','TUBAF-IfI-LiaScript','LiaPlayground','SebastianZug','andre-dietrich','LiaBooks','LiaTemplates','TUBAF-IUZ-LiaScript','markjjacob','HueblerPatricia']

  - name: Aggregate LiaScript files
    class: AggregateLiaScriptFiles
    parameters:
      repo_data_file_name_input: *REPOSITORIES_DF
      lia_files_name: &LIAFILES_DF LiaScript_files.p
      force_run: False

      # Optional: Exclude specific repository indices from processing
      exclude_repo_indices:
        - 439
        - 481
        - 497
        - 575

  - name: Validate LiaScript files with AI
    class: ValidateLiaScriptFiles
    parameters:
      file_name_input: *LIAFILES_DF
      file_name_output: &LIAFILES_VALIDATED_DF LiaScript_files_validated.p
      force_run: False
      model_name: llama3.3:70b
      max_content_length: 8000  # Characters to send to AI for validation
      validate_all: False  # Only validate files without validation result

      # LLM Configuration
      llm_config: *LLM_CONFIG

  - name: Aggregate LiaScript commits
    class: AggregateLiaScriptCommits
    parameters:
      lia_files_name_input: *LIAFILES_VALIDATED_DF
      lia_commits_name: &LIACOMMITS_DF LiaScript_commits.p
      force_run: False

  - name: Extract LiaScript metadata from headers
    class: ExtractLiaScriptMetadata
    parameters:
      lia_files_name_input: *LIAFILES_VALIDATED_DF
      lia_metadata_name: &LIAMETADATA_DF LiaScript_metadata.p
      force_run: False

  - name: Analyze LiaScript feature usage
    class: AnalyzeLiaScriptFeatures
    parameters:
      lia_files_name_input: *LIAFILES_VALIDATED_DF
      feature_analysis_name: &LIAFEATURES_DF LiaScript_features.p
      feature_stats_name: &LIAFEATURESTATS LiaScript_feature_statistics.p
      force_run: False

  - name: Extract content from markdown files
    class: ExtractFileContent
    parameters:
      file_name_input: *LIAFILES_VALIDATED_DF
      file_name_output: &LIASCONTENT_DF LiaScript_content.p
      force_run: False
      file_types: ['md']

  - name: Provide embeddings
    class: AIEmbeddingsGeneration
    parameters:
      file_name_input: *LIAFILES_VALIDATED_DF
      file_name_output: &LIACHROMAFILES LiaScript_embeddings_files.p
      force_run: False
      file_types: ['md']

      # LLM and Vector Store Configuration
      llm_config: *LLM_CONFIG

  - name: Extract AI metadata from content
    class: AIMetaDataExtraction
    parameters:
      file_name_input: *LIAFILES_VALIDATED_DF
      file_name_output: &LIAAIMETA LiaScript_ai_meta.p
      prompts_file_name: pipelines/liascript/prompts/prompts.yaml
      dewey_classification_file: dewey_classification.txt
      model_name: llama3.3:70b
      force_run: True
      file_types: ['md']

      # LLM and Vector Store Configuration
      llm_config: *LLM_CONFIG

      # Batch processing configuration
      batch_size: 50  # Save every 50 documents to reduce I/O overhead

      # Processing mode configuration
      processing_mode:
        # Force processing: These fields are ALWAYS processed (overwrite existing data)
        force_processing:
          - ai:education_level     # Force re-process: Update education level classification
          - ai:target_audience     # Force re-process: Update target audience description

        # Conditional processing: These fields are only processed if empty/missing
        conditional_processing:
          - ai:keywords_ext        # Only process if missing/empty or invalid count
          - ai:keywords_gen        # Only process if missing/empty or invalid count
          - ai:dewey               # Only process if missing/empty
          - ai:title               # Only process if missing/empty
          - ai:summary             # Only process if missing/empty

        # Skip configuration: Skip file if NO conditional fields need processing
        allow_skip_when_all_conditional_filled: false  # Process all files for force_processing fields